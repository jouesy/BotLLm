<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºæ…§å­¸ç¿’å®¢æœæ©Ÿå™¨äºº v8.3 - å¤šç­†æ¸…å„Ÿä¿®æ­£ç‰ˆ</title>
    <style>
        /* åŸºç¤æ¨£å¼ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .container {
            width: 100%;
            max-width: 1400px;
            display: grid;
            grid-template-columns: 1fr 2fr 1fr;
            gap: 20px;
            height: 85vh;
        }
        
        .panel {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow-y: auto;
        }
        
        .chat-panel {
            display: flex;
            flex-direction: column;
        }
        
        h2 {
            color: #4a5568;
            margin-bottom: 20px;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #f7fafc;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .message {
            margin-bottom: 15px;
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }
        
        .message.user {
            flex-direction: row-reverse;
        }
        
        .message-content {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 18px;
            position: relative;
        }
        
        .message.user .message-content {
            background: #667eea;
            color: white;
        }
        
        .message.bot .message-content {
            background: #e2e8f0;
            color: #2d3748;
        }
        
        .message-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            background: #cbd5e0;
        }
        
        /* åˆ†æœŸè©¦ç®—è¡¨æ ¼æ¨£å¼ */
        .installment-table {
            margin-top: 10px;
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
            background: white;
        }
        
        .installment-table th {
            background: #4a5568;
            color: white;
            padding: 8px;
            text-align: center;
            border: 1px solid #ddd;
            font-size: 0.8rem;
        }
        
        .installment-table td {
            padding: 6px;
            text-align: right;
            border: 1px solid #ddd;
        }
        
        .installment-table tr:nth-child(even) {
            background: #f7fafc;
        }
        
        .installment-table .total-row {
            font-weight: bold;
            background: #e2e8f0;
        }
        
        /* è©¦ç®—æ¯”è¼ƒè¡¨æ ¼ */
        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            font-size: 0.9rem;
        }
        
        .comparison-table th {
            background: #667eea;
            color: white;
            padding: 10px;
            text-align: center;
        }
        
        .comparison-table td {
            padding: 8px;
            text-align: center;
            border: 1px solid #e2e8f0;
        }
        
        .comparison-table tr:hover {
            background: #f0f4f8;
        }
        
        /* æå‰æ¸…å„Ÿæ¨£å¼ */
        .prepayment-box {
            background: #fef5e7;
            border: 2px solid #f39c12;
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
        }
        
        .prepayment-favorable {
            background: #d5f4e6;
            border-color: #27ae60;
        }
        
        .prepayment-unfavorable {
            background: #fadbd8;
            border-color: #e74c3c;
        }
        
        /* å¤šç­†è©¦ç®—åˆ†éš”ç·š */
        .installment-separator {
            border-top: 3px solid #667eea;
            margin: 20px 0;
            padding-top: 20px;
        }
        
        /* è©³ç´°æª¢è¦–æŒ‰éˆ•æ¨£å¼ */
        .detail-btn {
            background: #3182ce;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.2s;
        }
        
        .detail-btn:hover {
            background: #2c5282;
            transform: translateY(-1px);
        }
        
        /* ä¸Šæ¬¡æ¢ä»¶æç¤ºæ¨£å¼ */
        .last-condition-hint {
            background: #bee3f8;
            color: #2c5282;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 0.85rem;
            margin-top: 5px;
            display: inline-block;
        }
        
        .input-area {
            display: flex;
            gap: 10px;
        }
        
        .input-area input {
            flex: 1;
            padding: 15px;
            border: 2px solid #e2e8f0;
            border-radius: 25px;
            font-size: 1rem;
            transition: all 0.3s;
        }
        
        .input-area input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .send-btn {
            padding: 15px 30px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s;
        }
        
        .send-btn:hover {
            background: #5a67d8;
            transform: translateY(-2px);
        }
        
        /* å…¶ä»–æ¨£å¼ */
        .stats-card {
            background: #f7fafc;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
        }
        
        .stats-card h3 {
            color: #7f8c8d;
            font-size: 0.875rem;
            margin-bottom: 5px;
        }
        
        .stats-card .value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #667eea;
        }
        
        .training-btn {
            width: 100%;
            padding: 12px;
            background: #48bb78;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin-top: 10px;
            transition: all 0.3s;
        }
        
        .training-btn:hover {
            background: #38a169;
        }
        
        .thinking-indicator {
            display: none;
            padding: 10px;
            text-align: center;
            color: #718096;
            font-style: italic;
        }
        
        .thinking-indicator.active {
            display: block;
        }
        
        @keyframes pulse {
            0% { opacity: 0.6; }
            50% { opacity: 1; }
            100% { opacity: 0.6; }
        }
        
        .thinking-indicator.active::after {
            content: '...';
            animation: pulse 1.5s infinite;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- å·¦å´é¢æ¿ï¼šçµ±è¨ˆèˆ‡æ§åˆ¶ -->
        <div class="panel">
            <h2>ğŸ“Š å­¸ç¿’çµ±è¨ˆ</h2>
            
            <div class="stats-card">
                <h3>ç¸½å°è©±æ•¸</h3>
                <div class="value" id="totalConversations">0</div>
            </div>
            
            <div class="stats-card">
                <h3>çŸ¥è­˜é»æ•¸é‡</h3>
                <div class="value" id="knowledgeCount">0</div>
            </div>
            
            <div class="stats-card">
                <h3>ä¸Šæ¬¡è©¦ç®—æ¢ä»¶</h3>
                <div class="value" id="lastCalculation" style="font-size: 0.9rem;">å°šç„¡è¨˜éŒ„</div>
            </div>
            
            <button class="training-btn" onclick="showInstallmentGuide()">
                ğŸ’³ åˆ†æœŸè©¦ç®—èªªæ˜
            </button>
            <button class="training-btn" onclick="showPrepaymentGuide()">
                ğŸ’° æå‰æ¸…å„Ÿèªªæ˜
            </button>
            <button class="training-btn" onclick="showSmartFeatures()">
                ğŸ¯ æ™ºæ…§åŠŸèƒ½èªªæ˜
            </button>
            <button class="training-btn" style="background: #e53e3e;" onclick="resetLearning()">
                ğŸ”„ é‡ç½®å­¸ç¿’è³‡æ–™
            </button>
        </div>
        
        <!-- ä¸­é–“é¢æ¿ï¼šèŠå¤©ä»‹é¢ -->
        <div class="panel chat-panel">
            <h2>ğŸ¤– æ™ºæ…§å®¢æœåŠ©ç†</h2>
            
            <div class="chat-messages" id="chatMessages">
                <div class="message bot">
                    <div class="message-avatar">ğŸ¤–</div>
                    <div class="message-content">
                        <div>æ‚¨å¥½ï¼æˆ‘æ˜¯æ™ºæ…§ç‰ˆå­¸ç¿’åŠ©ç†ï¼Œæ”¯æ´æå‰æ¸…å„Ÿå’Œå¤šç­†åˆ†æœŸè©¦ç®—åŠŸèƒ½ã€‚<br><br>
                        ğŸ’¡ æ–°åŠŸèƒ½ï¼š<br>
                        â€¢ æå‰æ¸…å„Ÿè©¦ç®—ï¼ˆå«é•ç´„é‡‘è¨ˆç®—ï¼‰<br>
                        â€¢ å¤šç­†åˆ†æœŸè©¦ç®—ï¼ˆå«è©³ç´°æ˜ç´°ï¼‰<br>
                        â€¢ æ™ºæ…§æœŸæ•¸èª¿æ•´<br><br>
                        ğŸ’³ åˆ†æœŸè©¦ç®—æŒ‡ä»¤ï¼š<br>
                        â€¢ å¸³å–®åˆ†æœŸï¼šå¸³åˆ† é‡‘é¡ æœŸæ•¸/åˆ©ç‡ èµ·å§‹æœˆä»½<br>
                        â€¢ å–®ç­†åˆ†æœŸï¼šå–®åˆ† é‡‘é¡ æœŸæ•¸/åˆ©ç‡ è«‹æ¬¾æ—¥ çµå¸³æ—¥<br>
                        â€¢ ç„¡æ¯åˆ†æœŸï¼šç„¡åˆ† é‡‘é¡ æœŸæ•¸ èµ·å§‹æœˆä»½<br>
                        â€¢ å¤šæœŸè©¦ç®—ï¼šå¤šæœŸè©¦ç®— é¡å‹ é‡‘é¡ æœŸæ•¸/åˆ©ç‡ åƒæ•¸<br>
                        â€¢ å¤šç­†è©¦ç®—ï¼šå¤šç­†è©¦ç®— 1 é¡å‹ åƒæ•¸ 2 é¡å‹ åƒæ•¸...<br><br>
                        ğŸ’° æå‰æ¸…å„Ÿï¼š<br>
                        â€¢ å–®ç­†ï¼šé¡å‹ é‡‘é¡ æœŸæ•¸/åˆ©ç‡ åƒæ•¸ æ¸…å„Ÿæœˆä»½<br>
                        â€¢ å¤šç­†ï¼šæ¸…å„Ÿæœˆä»½+å¤šç­†æ¸…å„Ÿ 1 é¡å‹ åƒæ•¸ 2 é¡å‹ åƒæ•¸...<br><br>
                        è¼¸å…¥ã€Œèªªæ˜ã€æŸ¥çœ‹è©³ç´°ä½¿ç”¨æ–¹æ³•ã€‚</div>
                    </div>
                </div>
            </div>
            
            <div class="thinking-indicator" id="thinkingIndicator">
                æ©Ÿå™¨äººæ­£åœ¨è¨ˆç®—ä¸­
            </div>
            
            <div class="input-area">
                <input 
                    type="text" 
                    id="userInput" 
                    placeholder="è«‹è¼¸å…¥åˆ†æœŸè©¦ç®—æŒ‡ä»¤æˆ–æœŸæ•¸..." 
                    onkeypress="handleKeyPress(event)"
                />
                <button class="send-btn" onclick="sendMessage()">ç™¼é€</button>
            </div>
        </div>
        
        <!-- å³å´é¢æ¿ï¼šçŸ¥è­˜åº« -->
        <div class="panel">
            <h2>ğŸ“š å‹•æ…‹çŸ¥è­˜åº«</h2>
            
            <div style="margin-bottom: 20px;">
                <select id="categoryFilter" onchange="displayKnowledge()" style="width: 100%; padding: 8px; border-radius: 5px; border: 1px solid #e2e8f0;">
                    <option value="">æ‰€æœ‰é¡å‹</option>
                </select>
            </div>
            
            <div id="knowledgeDisplay" style="max-height: 600px; overflow-y: auto;">
                <!-- çŸ¥è­˜åº«å…§å®¹å°‡å‹•æ…‹é¡¯ç¤º -->
            </div>
        </div>
    </div>

    <script>
        // ========== å¢å¼·ç‰ˆå­¸ç¿’å¼•æ“ï¼ˆä¿®æ­£å¤šç­†æ¸…å„Ÿè­˜åˆ¥å•é¡Œï¼‰ ==========
        class EnhancedLearningChatbot {
            constructor() {
                this.knowledge = this.loadKnowledge() || {
                    patterns: [],
                    dataTypes: {},
                    entities: {},
                    responses: {},
                    feedback: []
                };
                
                this.stats = this.loadStats() || {
                    totalConversations: 0,
                    successfulResponses: 0,
                    failedResponses: 0,
                    learningProgress: 0
                };
                
                this.conversationHistory = [];
                this.debugMode = false;
                
                // è¨˜æ†¶ä¸Šæ¬¡è©¦ç®—æ¢ä»¶
                this.lastCalculation = this.loadLastCalculation() || null;
                
                // å„²å­˜å¤šæœŸæ¯”è¼ƒçš„è©³ç´°è³‡æ–™
                this.lastTrialCalculations = {};
                
                // é•ç´„é‡‘è¦å‰‡
                this.penaltyRules = {
                    1: 160,   // é¦–æœŸçµå¸³æ—¥å¾Œè‡³ç¬¬äºŒæœŸçµå¸³æ—¥å‰
                    2: 150,   // ç¬¬äºŒæœŸçµå¸³æ—¥å¾Œè‡³ç¬¬å…­æœŸçµå¸³æ—¥å‰
                    6: 140    // ç¬¬å…­æœŸçµå¸³æ—¥å¾Œè‡³ç¬¬åäºŒæœŸçµå¸³æ—¥å‰
                };
                
                this.initializeBaseKnowledge();
                this.addInstallmentKnowledge();
                
                // é¡¯ç¤ºä¸Šæ¬¡è©¦ç®—æ¢ä»¶
                this.displayLastCalculation();
            }
            
            // æ–°å¢åˆ†æœŸè©¦ç®—çŸ¥è­˜
            addInstallmentKnowledge() {
                const installmentKnowledge = [
                    {
                        pattern: ['å¸³åˆ†', 'å¸³å–®åˆ†æœŸ', 'å¸³å–®åˆ†æœŸè©¦ç®—'],
                        intent: 'statement_installment',
                        response: 'å¸³å–®åˆ†æœŸè©¦ç®—åŠŸèƒ½',
                        confidence: 1,
                        usage: 0,
                        dataType: 'åˆ†æœŸè©¦ç®—',
                        isFunction: true
                    },
                    {
                        pattern: ['å–®åˆ†', 'å–®ç­†åˆ†æœŸ', 'å–®ç­†åˆ†æœŸè©¦ç®—'],
                        intent: 'single_installment',
                        response: 'å–®ç­†åˆ†æœŸè©¦ç®—åŠŸèƒ½',
                        confidence: 1,
                        usage: 0,
                        dataType: 'åˆ†æœŸè©¦ç®—',
                        isFunction: true
                    },
                    {
                        pattern: ['ç„¡åˆ†', 'ç„¡æ¯åˆ†æœŸ', 'é›¶åˆ©ç‡', 'ç„¡æ¯åˆ†æœŸè©¦ç®—'],
                        intent: 'interest_free_installment',
                        response: 'ç„¡æ¯åˆ†æœŸè©¦ç®—åŠŸèƒ½',
                        confidence: 1,
                        usage: 0,
                        dataType: 'åˆ†æœŸè©¦ç®—',
                        isFunction: true
                    },
                    {
                        pattern: ['å¤šæœŸè©¦ç®—', 'å¤šæœŸæ¯”è¼ƒ'],
                        intent: 'multi_period_trial',
                        response: 'å¤šæœŸæ•¸æ¯”è¼ƒè©¦ç®—åŠŸèƒ½',
                        confidence: 1,
                        usage: 0,
                        dataType: 'åˆ†æœŸè©¦ç®—',
                        isFunction: true
                    },
                    {
                        pattern: ['å¤šç­†è©¦ç®—', 'å¤šç­†åˆ†æœŸ'],
                        intent: 'multi_installment',
                        response: 'å¤šç­†åˆ†æœŸè©¦ç®—åŠŸèƒ½',
                        confidence: 1,
                        usage: 0,
                        dataType: 'åˆ†æœŸè©¦ç®—',
                        isFunction: true
                    },
                    {
                        pattern: ['æå‰æ¸…å„Ÿ', 'æ¸…å„Ÿ', 'é•ç´„é‡‘', 'å¤šç­†æ¸…å„Ÿ'],
                        intent: 'prepayment',
                        response: 'æå‰æ¸…å„Ÿè©¦ç®—åŠŸèƒ½',
                        confidence: 1,
                        usage: 0,
                        dataType: 'åˆ†æœŸè©¦ç®—',
                        isFunction: true
                    }
                ];
                
                const existingIntents = this.knowledge.patterns.map(p => p.intent);
                installmentKnowledge.forEach(knowledge => {
                    if (!existingIntents.includes(knowledge.intent)) {
                        this.knowledge.patterns.push(knowledge);
                    }
                });
                
                this.saveKnowledge();
            }
            
            // å–å¾—åˆ†æœŸèªªæ˜
            getInstallmentHelp() {
                return `ğŸ“‹ åˆ†æœŸè©¦ç®—å®Œæ•´èªªæ˜ï¼š

1ï¸âƒ£ å¸³å–®åˆ†æœŸï¼ˆå¹´é‡‘æ³•ï¼‰
æ ¼å¼ï¼šå¸³åˆ† é‡‘é¡ æœŸæ•¸/åˆ©ç‡ èµ·å§‹æœˆä»½
ç¯„ä¾‹ï¼šå¸³åˆ† 50000 12/13.5 11401

2ï¸âƒ£ å–®ç­†åˆ†æœŸï¼ˆä¾å¤©è¨ˆæ¯ï¼‰
æ ¼å¼ï¼šå–®åˆ† é‡‘é¡ æœŸæ•¸/åˆ©ç‡ è«‹æ¬¾æ—¥ çµå¸³æ—¥
ç¯„ä¾‹ï¼šå–®åˆ† 30000 6/12 1140515 1140620

3ï¸âƒ£ ç„¡æ¯åˆ†æœŸ
æ ¼å¼ï¼šç„¡åˆ† é‡‘é¡ æœŸæ•¸ èµ·å§‹æœˆä»½
ç¯„ä¾‹ï¼šç„¡åˆ† 20000 3 11401

4ï¸âƒ£ å¤šæœŸè©¦ç®—ï¼ˆæ–°æ ¼å¼ï¼‰
æ ¼å¼ï¼šå¤šæœŸè©¦ç®— é¡å‹ é‡‘é¡ æœŸæ•¸/åˆ©ç‡ åƒæ•¸
ç¯„ä¾‹ï¼šå¤šæœŸè©¦ç®— å¸³åˆ† 50000 12/13.5 11403

5ï¸âƒ£ å¤šç­†è©¦ç®—ï¼ˆå«è©³ç´°æ˜ç´°ï¼‰
æ ¼å¼ï¼šå¤šç­†è©¦ç®— 1 é¡å‹ åƒæ•¸ 2 é¡å‹ åƒæ•¸...
ç¯„ä¾‹ï¼šå¤šç­†è©¦ç®— 1 å–®åˆ† 50000 12/13.5 1140102 1140116 2 å¸³åˆ† 50000 24/13.5 11310

ğŸ¯ æ™ºæ…§åŠŸèƒ½ï¼š
â€¢ ç›´æ¥è¼¸å…¥æœŸæ•¸ï¼ˆå¦‚ï¼š24ï¼‰å³å¯ä½¿ç”¨ä¸Šæ¬¡æ¢ä»¶é‡æ–°è¨ˆç®—
â€¢ åˆ©ç‡å¾Œçš„%ç¬¦è™Ÿå¯åŠ å¯ä¸åŠ 

ğŸ“Œ æ—¥æœŸæ ¼å¼èªªæ˜ï¼š
â€¢ æ°‘åœ‹å¹´æœˆï¼šYYYMMï¼ˆå¦‚ 11401 = æ°‘åœ‹114å¹´1æœˆï¼‰
â€¢ æ°‘åœ‹å¹´æœˆæ—¥ï¼šYYYMMDDï¼ˆå¦‚ 1140515 = æ°‘åœ‹114å¹´5æœˆ15æ—¥ï¼‰`;
            }
            
            // å–å¾—æå‰æ¸…å„Ÿèªªæ˜
            getPrepaymentHelp() {
                return `ğŸ’° æå‰æ¸…å„ŸåŠŸèƒ½èªªæ˜ï¼š

ğŸ“Œ æå‰æ¸…å„Ÿè©¦ç®—
åœ¨åˆ†æœŸæŒ‡ä»¤å¾ŒåŠ ä¸Šæ¸…å„Ÿæœˆä»½å³å¯è©¦ç®—æå‰æ¸…å„Ÿ

æ ¼å¼ç¯„ä¾‹ï¼š
â€¢ å–®ç­†ï¼šå–®åˆ† 50000 12/13.5 1140214 1140216 11406
â€¢ å¸³å–®ï¼šå¸³åˆ† 50000 12/13.5 11401 11406

âš ï¸ é•ç´„é‡‘è¦å‰‡ï¼š
â€¢ é¦–æœŸå¾Œè‡³ç¬¬2æœŸå‰ï¼š160å…ƒ
â€¢ ç¬¬2æœŸå¾Œè‡³ç¬¬6æœŸå‰ï¼š150å…ƒ  
â€¢ ç¬¬6æœŸå¾Œè‡³ç¬¬12æœŸå‰ï¼š140å…ƒ
â€¢ ç„¡æ¯åˆ†æœŸç„¡é•ç´„é‡‘

ğŸ“Š ç³»çµ±æœƒè¨ˆç®—ï¼š
1. å‰©é¤˜æœ¬é‡‘
2. é•ç´„é‡‘
3. çœä¸‹çš„åˆ©æ¯ï¼ˆå¾æ¸…å„ŸæœŸé–‹å§‹çš„æ‰€æœ‰åˆ©æ¯ï¼‰
4. æ˜¯å¦æœ‰åˆ©ï¼ˆçœä¸‹åˆ©æ¯ > é•ç´„é‡‘ï¼‰

ğŸ’¡ å¤šç­†æå‰æ¸…å„Ÿï¼š
æ ¼å¼ï¼šæ¸…å„Ÿæœˆä»½+å¤šç­†æ¸…å„Ÿ 1 é¡å‹ åƒæ•¸ 2 é¡å‹ åƒæ•¸...
ç¯„ä¾‹ï¼š11406å¤šç­†æ¸…å„Ÿ 1 å¸³åˆ† 50000 12/13.5 11401 2 å–®åˆ† 25000 24/13.5 1140204 1140216 3 ç„¡åˆ† 24000 12 11309

ç³»çµ±æœƒå½™ç¸½æ‰€æœ‰æ¸…å„Ÿé‡‘é¡ä¸¦æä¾›å»ºè­°ã€‚`;
            }
            
            // è™•ç†ä½¿ç”¨è€…è¼¸å…¥
            async processInput(input) {
                this.stats.totalConversations++;
                const startTime = Date.now();
                
                // é¡¯ç¤ºæ€è€ƒä¸­
                this.showThinking(true);
                
                const processedInput = input.toLowerCase().trim();
                
                // 1. æª¢æŸ¥æ˜¯å¦åªè¼¸å…¥æœŸæ•¸
                const periodsOnlyPattern = /^(\d+)æœŸ?$/;
                const periodsMatch = input.match(periodsOnlyPattern);
                
                if (periodsMatch && this.lastCalculation) {
                    const newPeriods = parseInt(periodsMatch[1]);
                    const result = this.recalculateWithNewPeriods(newPeriods);
                    
                    await this.simulateThinking(startTime);
                    this.showThinking(false);
                    
                    return result;
                }
                
                // 2. å„ªå…ˆæª¢æŸ¥æ˜¯å¦ç‚ºå¤šç­†æ¸…å„ŸæŒ‡ä»¤
                const multiPrepaymentPatterns = [
                    /(\d{5})\s*å¤šç­†æ¸…å„Ÿ\s+(.+)/,     // åŸæ ¼å¼ï¼š11406å¤šç­†æ¸…å„Ÿ
                    /(\d{5})å¤šç­†æ¸…å„Ÿ\s+(.+)/,        // ç„¡ç©ºæ ¼æ ¼å¼
                    /å¤šç­†æ¸…å„Ÿ\s+(\d{5})\s+(.+)/      // åå‘æ ¼å¼ï¼šå¤šç­†æ¸…å„Ÿ 11406
                ];
                
                let multiPrepaymentMatch = null;
                let prepaymentMonth = null;
                let installmentsData = null;
                
                for (const pattern of multiPrepaymentPatterns) {
                    const match = input.match(pattern);
                    if (match) {
                        if (pattern.toString().includes('å¤šç­†æ¸…å„Ÿ\\s+(\\d{5})')) {
                            // åå‘æ ¼å¼
                            prepaymentMonth = match[1];
                            installmentsData = match[2];
                        } else {
                            // æ­£å¸¸æ ¼å¼
                            prepaymentMonth = match[1];
                            installmentsData = match[2];
                        }
                        multiPrepaymentMatch = match;
                        break;
                    }
                }
                
                if (multiPrepaymentMatch) {
                    const result = this.calculateMultiPrepayment(prepaymentMonth, installmentsData);
                    
                    await this.simulateThinking(startTime);
                    this.showThinking(false);
                    
                    return result;
                }
                
                // 3. æª¢æŸ¥æ˜¯å¦ç‚ºåˆ†æœŸè©¦ç®—æŒ‡ä»¤ï¼ˆåŒ…å«æå‰æ¸…å„Ÿï¼‰
                const installmentResult = this.checkInstallmentCommand(input);
                if (installmentResult) {
                    await this.simulateThinking(startTime);
                    this.showThinking(false);
                    return installmentResult;
                }
                
                // 4. æª¢æŸ¥æ˜¯å¦ç‚ºæŸ¥çœ‹è©³ç´°æŒ‡ä»¤
                const detailPattern = /è©³ç´°\s*(\d+)/;
                const detailMatch = input.match(detailPattern);
                
                if (detailMatch && this.lastTrialCalculations) {
                    const periods = parseInt(detailMatch[1]);
                    const result = this.showDetailedCalculation(periods);
                    
                    await this.simulateThinking(startTime);
                    this.showThinking(false);
                    
                    return result;
                }
                
                // 5. å…¶ä»–æŒ‡ä»¤è™•ç†
                if (processedInput === 'èªªæ˜') {
                    await this.simulateThinking(startTime);
                    this.showThinking(false);
                    return {
                        text: this.getInstallmentHelp(),
                        confidence: 1,
                        intent: 'help'
                    };
                }
                
                if (processedInput.includes('æå‰æ¸…å„Ÿ') || processedInput.includes('å¤šç­†æ¸…å„Ÿ')) {
                    await this.simulateThinking(startTime);
                    this.showThinking(false);
                    return {
                        text: this.getPrepaymentHelp(),
                        confidence: 1,
                        intent: 'prepayment_help'
                    };
                }
                
                await this.simulateThinking(startTime);
                this.showThinking(false);
                return {
                    text: `æŠ±æ­‰ï¼Œæˆ‘æ‰¾ä¸åˆ°é—œæ–¼ã€Œ${input}ã€çš„ç›¸é—œè³‡è¨Šã€‚\n\næ‚¨å¯ä»¥è©¦è©¦åˆ†æœŸè©¦ç®—åŠŸèƒ½ï¼Œè¼¸å…¥ã€Œèªªæ˜ã€æŸ¥çœ‹ä½¿ç”¨æ–¹æ³•ã€‚`,
                    confidence: 0,
                    intent: 'unknown'
                };
            }
            
            // æª¢æŸ¥åˆ†æœŸè©¦ç®—æŒ‡ä»¤ï¼ˆä¿®æ”¹æª¢æŸ¥é †åºï¼Œå„ªå…ˆè™•ç†å¤šç­†ç›¸é—œæŒ‡ä»¤ï¼‰
            checkInstallmentCommand(input) {
                // ç§»é™¤ % ç¬¦è™Ÿä»¥çµ±ä¸€è™•ç†
                input = input.replace(/%/g, '');
                
                // 1. å„ªå…ˆæª¢æŸ¥æ˜¯å¦åŒ…å«å¤šç­†æ¸…å„Ÿé—œéµå­—ï¼ˆé¿å…è¢«èª¤èªç‚ºå–®ç­†åˆ†æœŸï¼‰
                if (input.includes('å¤šç­†æ¸…å„Ÿ')) {
                    // é€™æ˜¯å¤šç­†æ¸…å„ŸæŒ‡ä»¤ï¼Œè¿”å› null è®“ processInput è™•ç†
                    return null;
                }
                
                // 2. å¤šç­†è©¦ç®—æ ¼å¼
                const multiPattern = /å¤šç­†è©¦ç®—\s+(.+)/;
                const multiMatch = input.match(multiPattern);
                
                if (multiMatch) {
                    const installmentsData = multiMatch[1];
                    const result = this.calculateMultiInstallments(installmentsData);
                    return {
                        text: result,
                        confidence: 1,
                        intent: 'multi_installment_calculation'
                    };
                }
                
                // 3. å¤šæœŸè©¦ç®—æ–°æ ¼å¼ï¼šå¤šæœŸè©¦ç®— é¡å‹ é‡‘é¡ æœŸæ•¸/åˆ©ç‡ åƒæ•¸
                const multiPeriodPattern = /å¤šæœŸè©¦ç®—\s+(å¸³åˆ†|å–®åˆ†|ç„¡åˆ†)\s+(\d+)\s+(\d+)\/(\d+\.?\d*)\s*(.*)/;
                const multiPeriodMatch = input.match(multiPeriodPattern);
                
                if (multiPeriodMatch) {
                    const type = multiPeriodMatch[1];
                    const amount = parseFloat(multiPeriodMatch[2]);
                    const periods = parseInt(multiPeriodMatch[3]);
                    const rate = parseFloat(multiPeriodMatch[4]);
                    const params = multiPeriodMatch[5].trim();
                    
                    const result = this.performMultiPeriodTrial(type, amount, periods, rate, params);
                    return {
                        text: result,
                        confidence: 1,
                        intent: 'multi_period_trial_calculation'
                    };
                }
                
                // 4. å¸³å–®åˆ†æœŸæ ¼å¼ï¼ˆå«æå‰æ¸…å„Ÿï¼‰ï¼šå¸³åˆ† é‡‘é¡ æœŸæ•¸/åˆ©ç‡ èµ·å§‹æœˆä»½ [æ¸…å„Ÿæœˆä»½]
                const statementPattern = /å¸³åˆ†\s+(\d+)\s+(\d+)\/(\d+\.?\d*)\s+(\d{5})(?:\s+(\d{5}))?/;
                const statementMatch = input.match(statementPattern);
                
                if (statementMatch) {
                    const plan = {
                        loanAmount: parseFloat(statementMatch[1]),
                        numberOfInstallments: parseInt(statementMatch[2]),
                        annualInterestRate: parseFloat(statementMatch[3]),
                        statementPlanStartBillROC: statementMatch[4],
                        type: 'statement',
                        prepaymentMonth: statementMatch[5] || null
                    };
                    
                    if (plan.prepaymentMonth) {
                        const result = this.calculatePrepayment(plan);
                        return {
                            text: result,
                            confidence: 1,
                            intent: 'statement_prepayment_calculation'
                        };
                    } else {
                        this.saveLastCalculation(plan);
                        const result = this.calculateInstallmentPlan(plan);
                        return {
                            text: result,
                            confidence: 1,
                            intent: 'statement_installment_calculation'
                        };
                    }
                }
                
                // 5. å–®ç­†åˆ†æœŸæ ¼å¼ï¼ˆå«æå‰æ¸…å„Ÿï¼‰ï¼šå–®åˆ† é‡‘é¡ æœŸæ•¸/åˆ©ç‡ è«‹æ¬¾æ—¥ çµå¸³æ—¥ [æ¸…å„Ÿæœˆä»½]
                const singlePattern = /å–®åˆ†\s+(\d+)\s+(\d+)\/(\d+\.?\d*)\s+(\d{7})\s+(\d{7})(?:\s+(\d{5}))?/;
                const singleMatch = input.match(singlePattern);
                
                if (singleMatch) {
                    const plan = {
                        loanAmount: parseFloat(singleMatch[1]),
                        numberOfInstallments: parseInt(singleMatch[2]),
                        annualInterestRate: parseFloat(singleMatch[3]),
                        merchantBillingDateROC: singleMatch[4],
                        firstPaymentBillDateROC: singleMatch[5],
                        type: 'single',
                        prepaymentMonth: singleMatch[6] || null
                    };
                    
                    if (plan.prepaymentMonth) {
                        const result = this.calculatePrepayment(plan);
                        return {
                            text: result,
                            confidence: 1,
                            intent: 'single_prepayment_calculation'
                        };
                    } else {
                        this.saveLastCalculation(plan);
                        const result = this.calculateInstallmentPlan(plan);
                        return {
                            text: result,
                            confidence: 1,
                            intent: 'single_installment_calculation'
                        };
                    }
                }
                
                // 6. ç„¡æ¯åˆ†æœŸæ ¼å¼ï¼ˆå«æå‰æ¸…å„Ÿï¼‰ï¼šç„¡åˆ† é‡‘é¡ æœŸæ•¸ èµ·å§‹æœˆä»½ [æ¸…å„Ÿæœˆä»½]
                const freePattern = /ç„¡åˆ†\s+(\d+)\s+(\d+)\s+(\d{5})(?:\s+(\d{5}))?/;
                const freeMatch = input.match(freePattern);
                
                if (freeMatch) {
                    const plan = {
                        loanAmount: parseFloat(freeMatch[1]),
                        numberOfInstallments: parseInt(freeMatch[2]),
                        annualInterestRate: 0,
                        statementPlanStartBillROC: freeMatch[3],
                        type: 'interestFree',
                        prepaymentMonth: freeMatch[4] || null
                    };
                    
                    if (plan.prepaymentMonth) {
                        const result = this.calculatePrepayment(plan);
                        return {
                            text: result,
                            confidence: 1,
                            intent: 'interest_free_prepayment_calculation'
                        };
                    } else {
                        this.saveLastCalculation(plan);
                        const result = this.calculateInstallmentPlan(plan);
                        return {
                            text: result,
                            confidence: 1,
                            intent: 'interest_free_installment_calculation'
                        };
                    }
                }
                
                return null;
            }
            
            // è¨ˆç®—æå‰æ¸…å„Ÿ
            calculatePrepayment(plan) {
                // å…ˆè¨ˆç®—å®Œæ•´çš„åˆ†æœŸè¨ˆç•«
                this.calculateAmortization(plan);
                
                // æ‰¾å‡ºæ¸…å„Ÿæœˆä»½å°æ‡‰çš„æœŸæ•¸
                const prepaymentPeriod = this.findPrepaymentPeriod(plan, plan.prepaymentMonth);
                
                if (!prepaymentPeriod || prepaymentPeriod > plan.numberOfInstallments) {
                    return `âŒ éŒ¯èª¤ï¼šæ¸…å„Ÿæœˆä»½ ${plan.prepaymentMonth} ä¸åœ¨åˆ†æœŸç¯„åœå…§ã€‚`;
                }
                
                // è¨ˆç®—æå‰æ¸…å„Ÿè³‡è¨Š
                const prepaymentInfo = this.calculatePrepaymentInfo(plan, prepaymentPeriod);
                
                // æ ¼å¼åŒ–å›æ‡‰
                let response = this.formatPrepaymentResponse(plan, prepaymentInfo);
                
                return response;
            }
            
            // æ‰¾å‡ºæ¸…å„Ÿæœˆä»½å°æ‡‰çš„æœŸæ•¸
            findPrepaymentPeriod(plan, prepaymentMonth) {
                for (let i = 0; i < plan.amortizationSchedule.length; i++) {
                    if (plan.amortizationSchedule[i].billROCYearMonth === prepaymentMonth) {
                        return i + 1;
                    }
                }
                return null;
            }
            
            // è¨ˆç®—æå‰æ¸…å„Ÿè³‡è¨Šï¼ˆä¿®æ­£ç‰ˆï¼‰
            calculatePrepaymentInfo(plan, prepaymentPeriod) {
                const info = {
                    prepaymentPeriod: prepaymentPeriod,
                    remainingPrincipal: 0,
                    penaltyFee: 0,
                    savedInterest: 0,
                    totalPrepaymentAmount: 0,
                    isFavorable: false
                };
                
                // è¨ˆç®—å‰©é¤˜æœ¬é‡‘
                // å¦‚æœæ˜¯åœ¨ç¬¬NæœŸæ¸…å„Ÿï¼Œè¦æ¸…å„Ÿçš„æ˜¯ç¬¬N-1æœŸçµæŸå¾Œçš„å‰©é¤˜æœ¬é‡‘
                if (prepaymentPeriod > 1) {
                    info.remainingPrincipal = plan.amortizationSchedule[prepaymentPeriod - 2].remainingBalance;
                } else {
                    // ç¬¬1æœŸæ¸…å„Ÿæ™‚ï¼Œå‰©é¤˜æœ¬é‡‘å°±æ˜¯å…¨éƒ¨æœ¬é‡‘
                    info.remainingPrincipal = plan.loanAmount;
                }
                
                // è¨ˆç®—é•ç´„é‡‘ï¼ˆç„¡æ¯åˆ†æœŸç„¡é•ç´„é‡‘ï¼‰
                if (plan.annualInterestRate > 0 && (plan.type === 'single' || plan.type === 'statement')) {
                    if (prepaymentPeriod <= 1) {
                        info.penaltyFee = this.penaltyRules[1];
                    } else if (prepaymentPeriod <= 6) {
                        info.penaltyFee = this.penaltyRules[2];
                    } else if (prepaymentPeriod <= 12) {
                        info.penaltyFee = this.penaltyRules[6];
                    }
                }
                
                // ä¿®æ­£ï¼šè¨ˆç®—çœä¸‹çš„åˆ©æ¯
                // å¾æ¸…å„ŸæœŸé–‹å§‹ï¼ˆå«æ¸…å„ŸæœŸï¼‰åˆ°æœ€å¾Œä¸€æœŸçš„æ‰€æœ‰åˆ©æ¯
                for (let i = prepaymentPeriod - 1; i < plan.amortizationSchedule.length; i++) {
                    info.savedInterest += plan.amortizationSchedule[i].interest;
                }
                
                // è¨ˆç®—ç¸½æ¸…å„Ÿé‡‘é¡
                info.totalPrepaymentAmount = info.remainingPrincipal + info.penaltyFee;
                
                // åˆ¤æ–·æ˜¯å¦æœ‰åˆ©
                info.isFavorable = info.savedInterest > info.penaltyFee;
                
                return info;
            }
            
            // æ ¼å¼åŒ–æå‰æ¸…å„Ÿå›æ‡‰ï¼ˆä¿®æ­£ç‰ˆï¼‰
            formatPrepaymentResponse(plan, info) {
                let typeText = '';
                if (plan.type === 'statement') typeText = 'å¸³å–®åˆ†æœŸ';
                else if (plan.type === 'single') typeText = 'å–®ç­†åˆ†æœŸ';
                else if (plan.type === 'interestFree') typeText = 'ç„¡æ¯åˆ†æœŸ';
                
                let response = `ğŸ’° ${typeText}æå‰æ¸…å„Ÿè©¦ç®—çµæœ\n\n`;
                
                response += `ğŸ“Š åˆ†æœŸè³‡è¨Šï¼š\n`;
                response += `æœ¬é‡‘ï¼š$${this.formatNumber(plan.loanAmount)}\n`;
                response += `å¹´åˆ©ç‡ï¼š${plan.annualInterestRate}%\n`;
                response += `ç¸½æœŸæ•¸ï¼š${plan.numberOfInstallments}æœŸ\n`;
                response += `æ¸…å„Ÿæ™‚é»ï¼šç¬¬${info.prepaymentPeriod}æœŸå¸³å–®æœˆä»½\n\n`;
                
                response += `ğŸ’µ æ¸…å„Ÿè¨ˆç®—ï¼š\n`;
                response += `å‰©é¤˜æœ¬é‡‘ï¼š$${this.formatNumber(info.remainingPrincipal)}\n`;
                
                if (info.penaltyFee > 0) {
                    response += `é•ç´„é‡‘ï¼š$${this.formatNumber(info.penaltyFee)}\n`;
                    response += `ç¸½æ¸…å„Ÿé‡‘é¡ï¼š$${this.formatNumber(info.totalPrepaymentAmount)}\n\n`;
                    
                    response += `ğŸ’¡ æ•ˆç›Šåˆ†æï¼š\n`;
                    response += `çœä¸‹åˆ©æ¯ï¼ˆç¬¬${info.prepaymentPeriod}æœŸï½ç¬¬${plan.numberOfInstallments}æœŸï¼‰ï¼š$${this.formatNumber(info.savedInterest)}\n`;
                    response += `æ‰£é™¤é•ç´„é‡‘å¾Œæ·¨çœï¼š$${this.formatNumber(info.savedInterest - info.penaltyFee)}\n\n`;
                    
                    if (info.isFavorable) {
                        response += `<div class="prepayment-box prepayment-favorable">`;
                        response += `âœ… å»ºè­°ï¼šæå‰æ¸…å„Ÿã€æœ‰åˆ©ã€‘\n`;
                        response += `çœä¸‹çš„åˆ©æ¯ï¼ˆ$${this.formatNumber(info.savedInterest)}ï¼‰å¤§æ–¼é•ç´„é‡‘ï¼ˆ$${this.formatNumber(info.penaltyFee)}ï¼‰\n`;
                        response += `æ‚¨å¯ç¯€çœ $${this.formatNumber(info.savedInterest - info.penaltyFee)}`;
                        response += `</div>`;
                    } else {
                        response += `<div class="prepayment-box prepayment-unfavorable">`;
                        response += `âŒ å»ºè­°ï¼šæå‰æ¸…å„Ÿã€ä¸åˆ©ã€‘\n`;
                        response += `çœä¸‹çš„åˆ©æ¯ï¼ˆ$${this.formatNumber(info.savedInterest)}ï¼‰å°æ–¼é•ç´„é‡‘ï¼ˆ$${this.formatNumber(info.penaltyFee)}ï¼‰\n`;
                        response += `æ‚¨å°‡å¤šä»˜ $${this.formatNumber(info.penaltyFee - info.savedInterest)}`;
                        response += `</div>`;
                    }
                } else {
                    // ç„¡æ¯åˆ†æœŸ
                    response += `é•ç´„é‡‘ï¼š$0ï¼ˆç„¡æ¯åˆ†æœŸå…é•ç´„é‡‘ï¼‰\n`;
                    response += `ç¸½æ¸…å„Ÿé‡‘é¡ï¼š$${this.formatNumber(info.totalPrepaymentAmount)}\n\n`;
                    
                    response += `<div class="prepayment-box prepayment-favorable">`;
                    response += `âœ… ç„¡æ¯åˆ†æœŸå¯éš¨æ™‚æ¸…å„Ÿï¼Œç„¡éœ€æ”¯ä»˜é•ç´„é‡‘`;
                    response += `</div>`;
                }
                
                response += `\nâš ï¸ é‡è¦æé†’ï¼š\n`;
                response += `â€¢ æ¸…å„Ÿé‡‘é¡å°‡åˆ—å…¥ç¬¬${info.prepaymentPeriod}æœŸå¸³å–®æœ€ä½æ‡‰ç¹³\n`;
                response += `â€¢ éœ€ä¸€æ¬¡ç¹³æ¸…ï¼Œç„¡æ³•åˆ†æœŸ\n`;
                response += `â€¢ æå‰æ¸…å„Ÿç”³è«‹å¾Œç„¡æ³•å–æ¶ˆ\n`;
                
                if (!info.isFavorable && info.penaltyFee > 0) {
                    response += `\næ˜¯å¦ä»è¦ç¹¼çºŒç”³è«‹æå‰æ¸…å„Ÿï¼Ÿ`;
                }
                
                return response;
            }
            
            // è¨ˆç®—å¤šç­†åˆ†æœŸï¼ˆä¿®æ­£ï¼šåŠ å…¥è©³ç´°çµæœï¼‰
            calculateMultiInstallments(installmentsData) {
                const installments = this.parseMultiInstallments(installmentsData);
                
                if (installments.length === 0) {
                    return `âŒ ç„¡æ³•è§£æå¤šç­†åˆ†æœŸè³‡æ–™ï¼Œè«‹æª¢æŸ¥æ ¼å¼ã€‚`;
                }
                
                let response = `ğŸ“Š å¤šç­†åˆ†æœŸè©¦ç®—çµæœ\n\n`;
                let totalAmount = 0;
                let totalInterest = 0;
                let totalPayment = 0;
                
                // ç¬¬ä¸€éƒ¨åˆ†ï¼šæ‘˜è¦
                response += `ğŸ“Œ æ‘˜è¦è³‡è¨Šï¼š\n`;
                installments.forEach((installment, index) => {
                    // è¨ˆç®—æ­¤ç­†åˆ†æœŸ
                    this.calculateAmortization(installment.plan);
                    
                    response += `ã€ç¬¬${index + 1}ç­†ã€‘${installment.typeText}ï¼š`;
                    response += `$${this.formatNumber(installment.plan.loanAmount)} / `;
                    response += `${installment.plan.numberOfInstallments}æœŸ / `;
                    response += `${installment.plan.annualInterestRate}%\n`;
                    
                    totalAmount += installment.plan.loanAmount;
                    totalInterest += installment.plan.totalCalculatedInterest;
                    totalPayment += installment.plan.loanAmount + installment.plan.totalCalculatedInterest;
                });
                
                response += `\nğŸ“Œ å½™ç¸½ï¼š\n`;
                response += `ç¸½æœ¬é‡‘ï¼š$${this.formatNumber(totalAmount)}\n`;
                response += `ç¸½åˆ©æ¯ï¼š$${this.formatNumber(totalInterest)}\n`;
                response += `ç¸½ä»˜æ¬¾ï¼š$${this.formatNumber(totalPayment)}\n`;
                
                // ç¬¬äºŒéƒ¨åˆ†ï¼šå„ç­†è©³ç´°è³‡æ–™
                response += `\n\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
                response += `ğŸ“‹ å„ç­†åˆ†æœŸè©³ç´°æ˜ç´°\n`;
                response += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
                
                installments.forEach((installment, index) => {
                    if (index > 0) {
                        response += `<div class="installment-separator"></div>`;
                    }
                    
                    response += `\nã€ç¬¬${index + 1}ç­†ã€‘${installment.typeText}\n`;
                    response += this.formatInstallmentResponse(installment.plan);
                    response += `\n`;
                });
                
                return response;
            }
            
            // è¨ˆç®—å¤šç­†æå‰æ¸…å„Ÿ
            calculateMultiPrepayment(prepaymentMonth, installmentsData) {
                const installments = this.parseMultiInstallments(installmentsData);
                
                if (installments.length === 0) {
                    return {
                        text: `âŒ ç„¡æ³•è§£æå¤šç­†æ¸…å„Ÿè³‡æ–™ï¼Œè«‹æª¢æŸ¥æ ¼å¼ã€‚`,
                        confidence: 1,
                        intent: 'multi_prepayment_error'
                    };
                }
                
                let response = `ğŸ’° å¤šç­†æå‰æ¸…å„Ÿè©¦ç®—çµæœï¼ˆæ¸…å„Ÿæœˆä»½ï¼š${prepaymentMonth}ï¼‰\n\n`;
                let totalPrepaymentAmount = 0;
                let totalPenalty = 0;
                let totalSavedInterest = 0;
                let detailsArray = [];
                
                installments.forEach((installment, index) => {
                    // åŠ å…¥æ¸…å„Ÿæœˆä»½
                    installment.plan.prepaymentMonth = prepaymentMonth;
                    
                    // è¨ˆç®—åˆ†æœŸ
                    this.calculateAmortization(installment.plan);
                    
                    // æ‰¾å‡ºæ¸…å„ŸæœŸæ•¸
                    const prepaymentPeriod = this.findPrepaymentPeriod(installment.plan, prepaymentMonth);
                    
                    if (!prepaymentPeriod || prepaymentPeriod > installment.plan.numberOfInstallments) {
                        detailsArray.push({
                            index: index + 1,
                            typeText: installment.typeText,
                            error: true,
                            message: `æ¸…å„Ÿæœˆä»½ä¸åœ¨åˆ†æœŸç¯„åœå…§`
                        });
                        return;
                    }
                    
                    // è¨ˆç®—æå‰æ¸…å„Ÿè³‡è¨Š
                    const prepaymentInfo = this.calculatePrepaymentInfo(installment.plan, prepaymentPeriod);
                    
                    detailsArray.push({
                        index: index + 1,
                        typeText: installment.typeText,
                        plan: installment.plan,
                        info: prepaymentInfo,
                        error: false
                    });
                    
                    totalPrepaymentAmount += prepaymentInfo.totalPrepaymentAmount;
                    totalPenalty += prepaymentInfo.penaltyFee;
                    totalSavedInterest += prepaymentInfo.savedInterest;
                });
                
                // é¡¯ç¤ºå„ç­†æ˜ç´°
                detailsArray.forEach(detail => {
                    response += `ã€ç¬¬${detail.index}ç­†ã€‘${detail.typeText}\n`;
                    
                    if (detail.error) {
                        response += `âŒ ${detail.message}\n\n`;
                    } else {
                        response += `æœ¬é‡‘ï¼š$${this.formatNumber(detail.plan.loanAmount)}\n`;
                        response += `å‰©é¤˜æœ¬é‡‘ï¼š$${this.formatNumber(detail.info.remainingPrincipal)}\n`;
                        
                        if (detail.info.penaltyFee > 0) {
                            response += `é•ç´„é‡‘ï¼š$${this.formatNumber(detail.info.penaltyFee)}\n`;
                            response += `çœä¸‹åˆ©æ¯ï¼š$${this.formatNumber(detail.info.savedInterest)}\n`;
                            response += detail.info.isFavorable ? `âœ… æœ‰åˆ©` : `âŒ ä¸åˆ©`;
                            response += `ï¼ˆæ·¨çœ $${this.formatNumber(detail.info.savedInterest - detail.info.penaltyFee)}ï¼‰\n`;
                        } else {
                            response += `é•ç´„é‡‘ï¼š$0ï¼ˆç„¡æ¯åˆ†æœŸï¼‰\n`;
                        }
                        
                        response += `å°è¨ˆï¼š$${this.formatNumber(detail.info.totalPrepaymentAmount)}\n\n`;
                    }
                });
                
                // å½™ç¸½
                response += `ğŸ“Œ æ¸…å„Ÿå½™ç¸½ï¼š\n`;
                response += `ç¸½æ¸…å„Ÿæœ¬é‡‘ï¼š$${this.formatNumber(totalPrepaymentAmount - totalPenalty)}\n`;
                response += `ç¸½é•ç´„é‡‘ï¼š$${this.formatNumber(totalPenalty)}\n`;
                response += `ç¸½æ¸…å„Ÿé‡‘é¡ï¼š$${this.formatNumber(totalPrepaymentAmount)}\n\n`;
                
                response += `ğŸ’¡ æ•ˆç›Šåˆ†æï¼š\n`;
                response += `ç¸½çœåˆ©æ¯ï¼š$${this.formatNumber(totalSavedInterest)}\n`;
                response += `æ‰£é™¤é•ç´„é‡‘å¾Œæ·¨çœï¼š$${this.formatNumber(totalSavedInterest - totalPenalty)}\n\n`;
                
                if (totalSavedInterest > totalPenalty) {
                    response += `<div class="prepayment-box prepayment-favorable">`;
                    response += `âœ… æ•´é«”å»ºè­°ï¼šæå‰æ¸…å„Ÿã€æœ‰åˆ©ã€‘\n`;
                    response += `ç¸½è¨ˆå¯ç¯€çœ $${this.formatNumber(totalSavedInterest - totalPenalty)}`;
                    response += `</div>`;
                } else if (totalPenalty > 0) {
                    response += `<div class="prepayment-box prepayment-unfavorable">`;
                    response += `âŒ æ•´é«”å»ºè­°ï¼šæå‰æ¸…å„Ÿã€ä¸åˆ©ã€‘\n`;
                    response += `å°‡å¤šä»˜ $${this.formatNumber(totalPenalty - totalSavedInterest)}`;
                    response += `</div>`;
                }
                
                response += `\nâš ï¸ é‡è¦æé†’ï¼š\n`;
                response += `â€¢ ç¸½æ¸…å„Ÿé‡‘é¡ $${this.formatNumber(totalPrepaymentAmount)} å°‡åˆ—å…¥ä¸‹æœŸå¸³å–®\n`;
                response += `â€¢ éœ€ä¸€æ¬¡ç¹³æ¸…ï¼Œç„¡æ³•åˆ†æœŸ\n`;
                response += `â€¢ ç”³è«‹å¾Œç„¡æ³•å–æ¶ˆ`;
                
                return {
                    text: response,
                    confidence: 1,
                    intent: 'multi_prepayment_calculation'
                };
            }
            
            // è§£æå¤šç­†åˆ†æœŸè³‡æ–™
            parseMultiInstallments(data) {
                const installments = [];
                
                // è§£ææ ¼å¼ï¼š1 å–®åˆ† 50000 12/13.5 1140102 1140116 2 å¸³åˆ† 50000 24/13.5 11310
                const parts = data.trim().split(/\s+/);
                let i = 0;
                
                while (i < parts.length) {
                    if (/^\d+$/.test(parts[i])) {
                        // æ‰¾åˆ°åºè™Ÿ
                        i++; // è·³éåºè™Ÿ
                        
                        if (i >= parts.length) break;
                        
                        const type = parts[i++];
                        let plan = null;
                        let typeText = '';
                        
                        if (type === 'å–®åˆ†' && i + 4 < parts.length) {
                            const amount = parseFloat(parts[i++]);
                            const [periods, rate] = parts[i++].split('/');
                            const merchantDate = parts[i++];
                            const billDate = parts[i++];
                            
                            plan = {
                                loanAmount: amount,
                                numberOfInstallments: parseInt(periods),
                                annualInterestRate: parseFloat(rate),
                                merchantBillingDateROC: merchantDate,
                                firstPaymentBillDateROC: billDate,
                                type: 'single'
                            };
                            typeText = 'å–®ç­†åˆ†æœŸ';
                        } else if (type === 'å¸³åˆ†' && i + 2 < parts.length) {
                            const amount = parseFloat(parts[i++]);
                            const [periods, rate] = parts[i++].split('/');
                            const startMonth = parts[i++];
                            
                            plan = {
                                loanAmount: amount,
                                numberOfInstallments: parseInt(periods),
                                annualInterestRate: parseFloat(rate),
                                statementPlanStartBillROC: startMonth,
                                type: 'statement'
                            };
                            typeText = 'å¸³å–®åˆ†æœŸ';
                        } else if ((type === 'ç„¡åˆ†' || type === 'ç„¡æ¯') && i + 2 < parts.length) {
                            const amount = parseFloat(parts[i++]);
                            const periods = parseInt(parts[i++]);
                            const startMonth = parts[i++];
                            
                            plan = {
                                loanAmount: amount,
                                numberOfInstallments: periods,
                                annualInterestRate: 0,
                                statementPlanStartBillROC: startMonth,
                                type: 'interestFree'
                            };
                            typeText = 'ç„¡æ¯åˆ†æœŸ';
                        }
                        
                        if (plan) {
                            installments.push({ plan, typeText });
                        }
                    } else {
                        i++;
                    }
                }
                
                return installments;
            }
            
            // åŸ·è¡Œå¤šæœŸè©¦ç®—ï¼ˆæ–°æ ¼å¼ï¼‰
            performMultiPeriodTrial(type, amount, basePeriods, rate, params) {
                const trialPeriods = [3, 6, 12, 18, 24, 30];
                
                // æ¸…ç©ºä¹‹å‰çš„è©¦ç®—è³‡æ–™
                this.lastTrialCalculations = {};
                
                let response = `ğŸ“Š å¤šæœŸæ•¸æ¯”è¼ƒè©¦ç®—çµæœ\n`;
                response += `é¡å‹ï¼š${type === 'å¸³åˆ†' ? 'å¸³å–®åˆ†æœŸ' : type === 'å–®åˆ†' ? 'å–®ç­†åˆ†æœŸ' : 'ç„¡æ¯åˆ†æœŸ'}\n`;
                response += `æœ¬é‡‘ï¼š$${this.formatNumber(amount)}\n`;
                response += `å¹´åˆ©ç‡ï¼š${rate}%\n\n`;
                
                response += `<table class="comparison-table">`;
                response += `<tr><th>æœŸæ•¸</th><th>æ¯æœŸé‡‘é¡</th><th>ç¸½åˆ©æ¯</th><th>ç¸½ä»˜æ¬¾</th><th>æ“ä½œ</th></tr>`;
                
                trialPeriods.forEach(periods => {
                    let plan = {
                        loanAmount: amount,
                        numberOfInstallments: periods,
                        annualInterestRate: rate,
                        amortizationSchedule: []
                    };
                    
                    // æ ¹æ“šé¡å‹è¨­å®šåƒæ•¸
                    if (type === 'å¸³åˆ†') {
                        plan.type = 'statement';
                        plan.statementPlanStartBillROC = params || '11401';
                    } else if (type === 'å–®åˆ†') {
                        plan.type = 'single';
                        const dates = params.split(/\s+/);
                        plan.merchantBillingDateROC = dates[0] || '1140515';
                        plan.firstPaymentBillDateROC = dates[1] || '1140620';
                    } else if (type === 'ç„¡åˆ†') {
                        plan.type = 'interestFree';
                        plan.annualInterestRate = 0;
                        plan.statementPlanStartBillROC = params || '11401';
                    }
                    
                    try {
                        this.calculateAmortization(plan);
                        
                        // å„²å­˜è©³ç´°è¨ˆç®—çµæœ
                        this.lastTrialCalculations[periods] = plan;
                        
                        // è¨ˆç®—å¹³å‡æ¯æœŸé‡‘é¡
                        const avgPayment = Math.round((plan.loanAmount + plan.totalCalculatedInterest) / periods);
                        
                        response += `<tr>`;
                        response += `<td>${periods}æœŸ</td>`;
                        response += `<td>$${this.formatNumber(avgPayment)}</td>`;
                        response += `<td>$${this.formatNumber(plan.totalCalculatedInterest)}</td>`;
                        response += `<td>$${this.formatNumber(plan.loanAmount + plan.totalCalculatedInterest)}</td>`;
                        response += `<td><button class="detail-btn" onclick="sendDetailCommand(${periods})">è©³ç´°</button></td>`;
                        response += `</tr>`;
                    } catch (error) {
                        console.error(`è¨ˆç®—${periods}æœŸæ™‚ç™¼ç”ŸéŒ¯èª¤:`, error);
                    }
                });
                
                response += `</table>`;
                response += `\nğŸ’¡ æç¤ºï¼šé»æ“Šã€Œè©³ç´°ã€æŒ‰éˆ•æˆ–è¼¸å…¥ã€Œè©³ç´° æœŸæ•¸ã€æŸ¥çœ‹å®Œæ•´é‚„æ¬¾è¨ˆç•«`;
                
                return response;
            }
            
            // ä½¿ç”¨ä¸Šæ¬¡æ¢ä»¶é‡æ–°è¨ˆç®—
            recalculateWithNewPeriods(newPeriods) {
                if (!this.lastCalculation) {
                    return {
                        text: 'æ²’æœ‰æ‰¾åˆ°ä¸Šæ¬¡çš„è©¦ç®—æ¢ä»¶ï¼Œè«‹å…ˆé€²è¡Œä¸€æ¬¡å®Œæ•´çš„åˆ†æœŸè©¦ç®—ã€‚',
                        confidence: 1,
                        intent: 'no_last_calculation'
                    };
                }
                
                // è¤‡è£½ä¸Šæ¬¡çš„è¨ˆç®—æ¢ä»¶
                const newPlan = {
                    ...this.lastCalculation,
                    numberOfInstallments: newPeriods,
                    prepaymentMonth: null // æ¸…é™¤æå‰æ¸…å„Ÿæœˆä»½
                };
                
                // å»ºç«‹æç¤ºè¨Šæ¯
                let hint = `<div class="last-condition-hint">ä½¿ç”¨ä¸Šæ¬¡æ¢ä»¶ï¼šé‡‘é¡ $${this.formatNumber(newPlan.loanAmount)}ï¼Œåˆ©ç‡ ${newPlan.annualInterestRate}%ï¼Œæ”¹ç‚º ${newPeriods} æœŸ</div>\n\n`;
                
                // åŸ·è¡Œè¨ˆç®—
                const result = this.calculateInstallmentPlan(newPlan);
                
                return {
                    text: hint + result,
                    confidence: 1,
                    intent: 'recalculation_with_new_periods'
                };
            }
            
            // é¡¯ç¤ºè©³ç´°è¨ˆç®—çµæœ
            showDetailedCalculation(periods) {
                if (!this.lastTrialCalculations || !this.lastTrialCalculations[periods]) {
                    return {
                        text: `æ²’æœ‰æ‰¾åˆ° ${periods} æœŸçš„è©¦ç®—è³‡æ–™ï¼Œè«‹å…ˆé€²è¡Œå¤šæœŸæ¯”è¼ƒè©¦ç®—ã€‚`,
                        confidence: 1,
                        intent: 'no_trial_data'
                    };
                }
                
                const plan = this.lastTrialCalculations[periods];
                const response = this.formatInstallmentResponse(plan);
                
                return {
                    text: response,
                    confidence: 1,
                    intent: 'show_detailed_calculation'
                };
            }
            
            // è¨ˆç®—åˆ†æœŸè¨ˆç•«
            calculateInstallmentPlan(plan) {
                try {
                    // åŸ·è¡Œæ ¸å¿ƒè¨ˆç®—
                    this.calculateAmortization(plan);
                    
                    // å»ºç«‹å›æ‡‰
                    let response = this.formatInstallmentResponse(plan);
                    
                    return response;
                } catch (error) {
                    return `è¨ˆç®—éŒ¯èª¤ï¼š${error.message}`;
                }
            }
            
            // æ ¸å¿ƒåˆ†æœŸè¨ˆç®—é‚è¼¯ï¼ˆä¿æŒåŸæœ‰é‚è¼¯ï¼‰
            calculateAmortization(plan) {
                plan.amortizationSchedule = [];
                let currentRemainingPrincipal = plan.loanAmount;
                const monthlyRate = plan.annualInterestRate / 100 / 12;
                let firstBillDate;
                let overallTotalInterest = 0;
                
                // ç¢ºå®šé¦–æœŸå¸³å–®æ—¥æœŸ
                if (plan.type === 'statement' || plan.type === 'interestFree') {
                    const startBillROCYear = parseInt(plan.statementPlanStartBillROC.substring(0, 3));
                    const startBillROCMonth = parseInt(plan.statementPlanStartBillROC.substring(3, 5));
                    firstBillDate = new Date(startBillROCYear + 1911, startBillROCMonth - 1, 1);
                } else {
                    const firstPaymentStatementDate = this.rocYYYMMDDToDate(plan.firstPaymentBillDateROC);
                    const merchantDate = this.rocYYYMMDDToDate(plan.merchantBillingDateROC);
                    firstBillDate = new Date(firstPaymentStatementDate);
                    while (firstBillDate <= merchantDate) {
                        firstBillDate.setMonth(firstBillDate.getMonth() + 1);
                    }
                }
                
                let currentBillDate = new Date(firstBillDate);
                
                // ç„¡æ¯åˆ†æœŸè¨ˆç®—
                if (plan.annualInterestRate === 0) {
                    const basePrincipal = Math.floor(plan.loanAmount / plan.numberOfInstallments);
                    const remainder = plan.loanAmount % plan.numberOfInstallments;
                    
                    for (let i = 1; i <= plan.numberOfInstallments; i++) {
                        let principal = (i === 1) ? basePrincipal + remainder : basePrincipal;
                        let interest = 0;
                        let payment = principal;
                        
                        if (i === plan.numberOfInstallments && currentRemainingPrincipal !== principal) {
                            principal = currentRemainingPrincipal;
                            payment = principal;
                        }
                        
                        if (principal > currentRemainingPrincipal) principal = currentRemainingPrincipal;
                        
                        const billROCYear = currentBillDate.getFullYear() - 1911;
                        const billROCMonth = currentBillDate.getMonth() + 1;
                        
                        plan.amortizationSchedule.push({
                            period: i,
                            principal: principal,
                            interest: interest,
                                                        totalPayment: payment,
                            remainingBalance: currentRemainingPrincipal - principal,
                            billROCYearMonth: `${String(billROCYear).padStart(3, '0')}${String(billROCMonth).padStart(2, '0')}`
                        });
                        
                        currentRemainingPrincipal -= principal;
                        if (Math.abs(currentRemainingPrincipal) < 0.01) currentRemainingPrincipal = 0;
                        currentBillDate.setMonth(currentBillDate.getMonth() + 1);
                    }
                } else {
                    // å¸³å–®åˆ†æœŸï¼ˆå¹´é‡‘æ³•ï¼‰
                    if (plan.type === 'statement') {
                        const ratePowerN = Math.pow(1 + monthlyRate, plan.numberOfInstallments);
                        const monthlyPaymentRaw = plan.loanAmount * (monthlyRate * ratePowerN) / (ratePowerN - 1);
                        const paymentPerPeriodFixed = Math.round(monthlyPaymentRaw);
                        
                        for (let i = 1; i <= plan.numberOfInstallments; i++) {
                            let interest = Math.round(currentRemainingPrincipal * monthlyRate);
                            let principal;
                            let payment = paymentPerPeriodFixed;
                            
                            if (i === plan.numberOfInstallments) {
                                principal = currentRemainingPrincipal;
                                payment = principal + interest;
                            } else {
                                principal = payment - interest;
                            }
                            
                            if (principal > currentRemainingPrincipal) principal = currentRemainingPrincipal;
                            if (principal < 0 && currentRemainingPrincipal > 0) principal = 0;
                            
                            overallTotalInterest += interest;
                            
                            const billROCYear = currentBillDate.getFullYear() - 1911;
                            const billROCMonth = currentBillDate.getMonth() + 1;
                            
                            plan.amortizationSchedule.push({
                                period: i,
                                principal: principal,
                                interest: interest,
                                totalPayment: payment,
                                remainingBalance: currentRemainingPrincipal - principal,
                                billROCYearMonth: `${String(billROCYear).padStart(3, '0')}${String(billROCMonth).padStart(2, '0')}`
                            });
                            
                            currentRemainingPrincipal -= principal;
                            if (Math.abs(currentRemainingPrincipal) < 0.01) currentRemainingPrincipal = 0;
                            currentBillDate.setMonth(currentBillDate.getMonth() + 1);
                        }
                    } else if (plan.type === 'single') {
                        // å–®ç­†åˆ†æœŸï¼ˆç‰¹æ®Šé¦–æœŸè¨ˆç®—ï¼‰
                        const merchantDate = this.rocYYYMMDDToDate(plan.merchantBillingDateROC);
                        const timeDiff = firstBillDate.getTime() - merchantDate.getTime();
                        const daysInFirstPeriod = Math.max(0, Math.round(timeDiff / (1000 * 60 * 60 * 24)));
                        
                        // æ¨™æº–å¹´é‡‘æ³•è¨ˆç®—
                        const ratePowerN_base = Math.pow(1 + monthlyRate, plan.numberOfInstallments);
                        let baseMonthlyPaymentRaw;
                        if (ratePowerN_base - 1 === 0) {
                            baseMonthlyPaymentRaw = plan.loanAmount / plan.numberOfInstallments;
                        } else {
                            baseMonthlyPaymentRaw = plan.loanAmount * (monthlyRate * ratePowerN_base) / (ratePowerN_base - 1);
                        }
                        
                        const standardFirstMonthInterestRaw = plan.loanAmount * monthlyRate;
                        const standardAnnuityFirstPrincipalRaw = baseMonthlyPaymentRaw - standardFirstMonthInterestRaw;
                        
                        // é¦–æœŸè¨ˆç®—
                        let firstPeriodInterest = Math.round(plan.loanAmount * (plan.annualInterestRate / 100 / 365) * daysInFirstPeriod);
                        let firstPeriodPrincipal = 0;
                        
                        if (plan.numberOfInstallments === 1) {
                            firstPeriodPrincipal = plan.loanAmount;
                        } else {
                            const daysInBillingMonth = this.getDaysInMonth(merchantDate.getFullYear(), merchantDate.getMonth() + 1);
                            if (daysInBillingMonth > 0 && daysInFirstPeriod >= 0 && standardAnnuityFirstPrincipalRaw !== undefined) {
                                firstPeriodPrincipal = Math.round(standardAnnuityFirstPrincipalRaw / daysInBillingMonth * daysInFirstPeriod);
                            }
                        }
                        
                        if (firstPeriodPrincipal > plan.loanAmount) firstPeriodPrincipal = plan.loanAmount;
                        let firstPeriodPayment = firstPeriodPrincipal + firstPeriodInterest;
                        
                        overallTotalInterest += firstPeriodInterest;
                        currentRemainingPrincipal -= firstPeriodPrincipal;
                        if (Math.abs(currentRemainingPrincipal) < 0.01) currentRemainingPrincipal = 0;
                        
                        const firstBillROCYear = firstBillDate.getFullYear() - 1911;
                        const firstBillROCMonth = firstBillDate.getMonth() + 1;
                        
                        plan.amortizationSchedule.push({
                            period: 1,
                            principal: firstPeriodPrincipal,
                            interest: firstPeriodInterest,
                            totalPayment: firstPeriodPayment,
                            remainingBalance: currentRemainingPrincipal,
                            billROCYearMonth: `${String(firstBillROCYear).padStart(3, '0')}${String(firstBillROCMonth).padStart(2, '0')}`,
                            daysInPeriod: daysInFirstPeriod
                        });
                        
                        // å¾ŒçºŒæœŸæ•¸è¨ˆç®—
                        if (plan.numberOfInstallments > 1 && currentRemainingPrincipal > 0) {
                            const remainingInstallmentsCount = plan.numberOfInstallments - 1;
                            const ratePowerN_sub = Math.pow(1 + monthlyRate, remainingInstallmentsCount);
                            let paymentForSubsequentPeriodsRaw;
                            
                            if (ratePowerN_sub - 1 === 0 || remainingInstallmentsCount === 0) {
                                paymentForSubsequentPeriodsRaw = currentRemainingPrincipal > 0 && remainingInstallmentsCount > 0 ?
                                    currentRemainingPrincipal / remainingInstallmentsCount : 0;
                            } else {
                                paymentForSubsequentPeriodsRaw = currentRemainingPrincipal * (monthlyRate * ratePowerN_sub) / (ratePowerN_sub - 1);
                            }
                            
                            const paymentForSubsequentPeriodsFixed = Math.round(paymentForSubsequentPeriodsRaw);
                            let currentSubBillDate = new Date(firstBillDate);
                            
                            for (let i = 2; i <= plan.numberOfInstallments; i++) {
                                currentSubBillDate.setMonth(currentSubBillDate.getMonth() + 1);
                                const billROCYear = currentSubBillDate.getFullYear() - 1911;
                                const billROCMonth = currentSubBillDate.getMonth() + 1;
                                
                                let interest = Math.round(currentRemainingPrincipal * monthlyRate);
                                let principal;
                                let payment = paymentForSubsequentPeriodsFixed;
                                
                                if (i === plan.numberOfInstallments) {
                                    principal = currentRemainingPrincipal;
                                    payment = principal + interest;
                                } else {
                                    principal = payment - interest;
                                }
                                
                                if (principal > currentRemainingPrincipal) principal = currentRemainingPrincipal;
                                if (principal < 0 && currentRemainingPrincipal > 0) principal = 0;
                                
                                overallTotalInterest += interest;
                                currentRemainingPrincipal -= principal;
                                if (Math.abs(currentRemainingPrincipal) < 0.01) currentRemainingPrincipal = 0;
                                if (i === plan.numberOfInstallments) currentRemainingPrincipal = 0;
                                
                                plan.amortizationSchedule.push({
                                    period: i,
                                    principal: principal,
                                    interest: interest,
                                    totalPayment: payment,
                                    remainingBalance: currentRemainingPrincipal,
                                    billROCYearMonth: `${String(billROCYear).padStart(3, '0')}${String(billROCMonth).padStart(2, '0')}`
                                });
                            }
                        }
                    }
                }
                
                // è™•ç†æœ€çµ‚å¾®å°å·®é¡
                if (Math.abs(currentRemainingPrincipal) > 0.01 && plan.amortizationSchedule.length > 0) {
                    const lastEntry = plan.amortizationSchedule[plan.amortizationSchedule.length - 1];
                    lastEntry.principal += currentRemainingPrincipal;
                    lastEntry.totalPayment += currentRemainingPrincipal;
                    lastEntry.remainingBalance = 0;
                }
                
                plan.totalCalculatedInterest = overallTotalInterest;
            }
            
            // æ ¼å¼åŒ–åˆ†æœŸå›æ‡‰
            formatInstallmentResponse(plan) {
                let typeText = '';
                if (plan.type === 'statement') typeText = 'å¸³å–®åˆ†æœŸ';
                else if (plan.type === 'single') typeText = 'å–®ç­†åˆ†æœŸ';
                else if (plan.type === 'interestFree') typeText = 'ç„¡æ¯åˆ†æœŸ';
                
                let response = `ğŸ“Š ${typeText}è©¦ç®—çµæœ\n`;
                response += `æœ¬é‡‘ï¼š$${this.formatNumber(plan.loanAmount)}\n`;
                response += `å¹´åˆ©ç‡ï¼š${plan.annualInterestRate}%\n`;
                response += `æœŸæ•¸ï¼š${plan.numberOfInstallments}æœŸ\n`;
                
                if (plan.type === 'single' && plan.amortizationSchedule[0]?.daysInPeriod) {
                    response += `é¦–æœŸè¨ˆæ¯å¤©æ•¸ï¼š${plan.amortizationSchedule[0].daysInPeriod}å¤©\n`;
                }
                
                response += `\n<table class="installment-table">`;
                response += `<tr><th>æœŸæ•¸</th><th>å¸³å–®æœˆä»½</th><th>æœ¬é‡‘</th><th>åˆ©æ¯</th><th>æœ¬æœŸæ‡‰ä»˜</th><th>å‰©é¤˜æœ¬é‡‘</th></tr>`;
                
                plan.amortizationSchedule.forEach(inst => {
                    response += `<tr>`;
                    response += `<td>${inst.period}</td>`;
                    response += `<td>${inst.billROCYearMonth}</td>`;
                    response += `<td>$${this.formatNumber(inst.principal)}</td>`;
                    response += `<td>$${this.formatNumber(inst.interest)}</td>`;
                    response += `<td>$${this.formatNumber(inst.totalPayment)}</td>`;
                    response += `<td>$${this.formatNumber(inst.remainingBalance)}</td>`;
                    response += `</tr>`;
                });
                
                response += `<tr class="total-row">`;
                response += `<td colspan="2">åˆè¨ˆ</td>`;
                response += `<td>$${this.formatNumber(plan.loanAmount)}</td>`;
                response += `<td>$${this.formatNumber(plan.totalCalculatedInterest)}</td>`;
                response += `<td>$${this.formatNumber(plan.loanAmount + plan.totalCalculatedInterest)}</td>`;
                response += `<td>-</td>`;
                response += `</tr>`;
                response += `</table>`;
                
                response += `\nğŸ’° ç¸½åˆ©æ¯ï¼š$${this.formatNumber(plan.totalCalculatedInterest)}`;
                response += `\nğŸ’µ ç¸½ä»˜æ¬¾ï¼š$${this.formatNumber(plan.loanAmount + plan.totalCalculatedInterest)}`;
                response += `\n\nğŸ’¡ æç¤ºï¼šç›´æ¥è¼¸å…¥æ–°çš„æœŸæ•¸ï¼ˆå¦‚ï¼š24ï¼‰å³å¯ä½¿ç”¨ç›¸åŒæ¢ä»¶é‡æ–°è¨ˆç®—`;
                
                return response;
            }
            
            // å·¥å…·å‡½æ•¸ï¼šæ°‘åœ‹æ—¥æœŸè½‰æ›
            rocYYYMMDDToDate(rocDate) {
                const year = parseInt(rocDate.substring(0, 3)) + 1911;
                const month = parseInt(rocDate.substring(3, 5)) - 1;
                const day = parseInt(rocDate.substring(5, 7));
                return new Date(year, month, day);
            }
            
            // å–å¾—è©²æœˆå¤©æ•¸
            getDaysInMonth(year, month) {
                return new Date(year, month, 0).getDate();
            }
            
            // æ ¼å¼åŒ–æ•¸å­—ï¼ˆåŠ å…¥åƒåˆ†ä½ï¼‰
            formatNumber(num) {
                return Math.round(num).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
            }
            
            // å„²å­˜ä¸Šæ¬¡è¨ˆç®—æ¢ä»¶
            saveLastCalculation(plan) {
                this.lastCalculation = plan;
                localStorage.setItem('lastCalculation', JSON.stringify(plan));
                this.displayLastCalculation();
            }
            
            // è¼‰å…¥ä¸Šæ¬¡è¨ˆç®—æ¢ä»¶
            loadLastCalculation() {
                const saved = localStorage.getItem('lastCalculation');
                return saved ? JSON.parse(saved) : null;
            }
            
            // é¡¯ç¤ºä¸Šæ¬¡è¨ˆç®—æ¢ä»¶
            displayLastCalculation() {
                const display = document.getElementById('lastCalculation');
                if (this.lastCalculation) {
                    let typeText = '';
                    if (this.lastCalculation.type === 'statement') typeText = 'å¸³å–®åˆ†æœŸ';
                    else if (this.lastCalculation.type === 'single') typeText = 'å–®ç­†åˆ†æœŸ';
                    else if (this.lastCalculation.type === 'interestFree') typeText = 'ç„¡æ¯åˆ†æœŸ';
                    
                    display.innerHTML = `${typeText}<br>$${this.formatNumber(this.lastCalculation.loanAmount)} / ${this.lastCalculation.numberOfInstallments}æœŸ / ${this.lastCalculation.annualInterestRate}%`;
                } else {
                    display.textContent = 'å°šç„¡è¨˜éŒ„';
                }
            }
            
            // å…¶ä»–åŸæœ‰æ–¹æ³•ä¿æŒä¸è®Š...
            initializeBaseKnowledge() {
                if (this.knowledge.patterns.length === 0) {
                    const baseKnowledge = [
                        {
                            pattern: ['é€€è²¨', 'é€€æ›', 'é€€æ¬¾', 'ä¸ƒå¤©'],
                            intent: 'return_policy',
                            response: 'æ ¹æ“šæ¶ˆè²»è€…ä¿è­·æ³•ï¼Œæ‚¨äº«æœ‰å•†å“åˆ°è²¨ä¸ƒå¤©é‘‘è³æœŸï¼ˆå«ä¾‹å‡æ—¥ï¼‰ã€‚',
                            confidence: 0.9,
                            usage: 0,
                            dataType: 'åŸºç¤çŸ¥è­˜'
                        }
                    ];
                    
                    this.knowledge.patterns = baseKnowledge;
                    this.saveKnowledge();
                }
            }
            
            async simulateThinking(startTime) {
                const thinkingTime = Math.max(500, 1500 - (Date.now() - startTime));
                await new Promise(resolve => setTimeout(resolve, thinkingTime));
            }
            
            showThinking(show) {
                const indicator = document.getElementById('thinkingIndicator');
                if (show) {
                    indicator.classList.add('active');
                } else {
                    indicator.classList.remove('active');
                }
            }
            
            updateUI() {
                document.getElementById('totalConversations').textContent = this.stats.totalConversations;
                document.getElementById('knowledgeCount').textContent = this.knowledge.patterns.length;
                
                const categoryFilter = document.getElementById('categoryFilter');
                categoryFilter.innerHTML = '<option value="">æ‰€æœ‰é¡å‹</option>' +
                    '<option value="åˆ†æœŸè©¦ç®—">åˆ†æœŸè©¦ç®—</option>' +
                    '<option value="åŸºç¤çŸ¥è­˜">åŸºç¤çŸ¥è­˜</option>';
                
                displayKnowledge();
            }
            
            saveKnowledge() {
                localStorage.setItem('enhanced_chatbot_knowledge', JSON.stringify(this.knowledge));
            }
            
            loadKnowledge() {
                const saved = localStorage.getItem('enhanced_chatbot_knowledge');
                return saved ? JSON.parse(saved) : null;
            }
            
            saveStats() {
                localStorage.setItem('enhanced_chatbot_stats', JSON.stringify(this.stats));
            }
            
            loadStats() {
                const saved = localStorage.getItem('enhanced_chatbot_stats');
                return saved ? JSON.parse(saved) : null;
            }
        }
        
        // ========== UI å‡½æ•¸ ==========
        let chatbot = new EnhancedLearningChatbot();
        
        // ç™¼é€è¨Šæ¯
        async function sendMessage() {
            const input = document.getElementById('userInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            // é¡¯ç¤ºä½¿ç”¨è€…è¨Šæ¯
            addMessage(message, true);
            input.value = '';
            
            // è™•ç†æŸ¥è©¢
            const response = await chatbot.processInput(message);
            
            // é¡¯ç¤ºå›æ‡‰ï¼ˆæ”¯æ´HTMLè¡¨æ ¼ï¼‰
            addMessage(response.text, false, response.confidence, true);
            
            chatbot.saveStats();
            chatbot.updateUI();
        }
        
        // ç™¼é€è©³ç´°æŒ‡ä»¤
        function sendDetailCommand(periods) {
            const input = document.getElementById('userInput');
            input.value = `è©³ç´° ${periods}`;
            sendMessage();
        }
        
        // æ·»åŠ è¨Šæ¯ï¼ˆæ”¯æ´HTMLå…§å®¹ï¼‰
        function addMessage(text, isUser, confidence = null, allowHtml = false) {
            const messagesDiv = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'user' : 'bot'}`;
            
            const avatar = document.createElement('div');
            avatar.className = 'message-avatar';
            avatar.textContent = isUser ? 'ğŸ‘¤' : 'ğŸ¤–';
            
            const content = document.createElement('div');
            content.className = 'message-content';
            
            if (allowHtml && !isUser) {
                // å…è¨±HTMLå…§å®¹ï¼ˆç”¨æ–¼é¡¯ç¤ºè¡¨æ ¼ï¼‰
                content.innerHTML = `<div>${text}</div>`;
            } else {
                // ä¸€èˆ¬æ–‡å­—è¨Šæ¯
                const formattedText = text.replace(/\n/g, '<br>');
                content.innerHTML = `<div>${formattedText}</div>`;
            }
            
            if (!isUser && confidence !== null && confidence < 1) {
                content.innerHTML += `<div style="font-size: 0.75rem; opacity: 0.7; margin-top: 5px;">ä¿¡å¿ƒåº¦ï¼š${Math.round(confidence * 100)}%</div>`;
            }
            
            messageDiv.appendChild(avatar);
            messageDiv.appendChild(content);
            messagesDiv.appendChild(messageDiv);
            
            // æ»¾å‹•åˆ°åº•éƒ¨
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }
        
        // é¡¯ç¤ºåˆ†æœŸè©¦ç®—èªªæ˜
        function showInstallmentGuide() {
            const guide = chatbot.getInstallmentHelp();
            addMessage(guide, false, 1);
        }
        
        // é¡¯ç¤ºæå‰æ¸…å„Ÿèªªæ˜
        function showPrepaymentGuide() {
            const guide = chatbot.getPrepaymentHelp();
            addMessage(guide, false, 1);
        }
        
        // é¡¯ç¤ºæ™ºæ…§åŠŸèƒ½èªªæ˜
        function showSmartFeatures() {
            const guide = `ğŸ¯ æ™ºæ…§åŠŸèƒ½èªªæ˜ï¼š

ğŸ“Œ è¨˜æ†¶è©¦ç®—æ¢ä»¶
ç•¶æ‚¨å®Œæˆä¸€æ¬¡åˆ†æœŸè©¦ç®—å¾Œï¼Œç³»çµ±æœƒè¨˜ä½æ‚¨çš„æ¢ä»¶ã€‚
ä¹‹å¾Œåªè¦è¼¸å…¥æ–°çš„æœŸæ•¸ï¼Œå°±èƒ½å¿«é€Ÿé‡æ–°è¨ˆç®—ã€‚

ç¯„ä¾‹ï¼š
1. å…ˆè©¦ç®—ï¼šå¸³åˆ† 50000 12/13.5 11401
2. æƒ³æ”¹æˆ24æœŸï¼Ÿç›´æ¥è¼¸å…¥ï¼š24
3. æƒ³æ”¹æˆ36æœŸï¼Ÿç›´æ¥è¼¸å…¥ï¼š36

ğŸ“Œ æå‰æ¸…å„Ÿè©¦ç®—
åœ¨åˆ†æœŸæŒ‡ä»¤å¾ŒåŠ ä¸Šæ¸…å„Ÿæœˆä»½å³å¯ã€‚
ç³»çµ±æœƒè‡ªå‹•è¨ˆç®—é•ç´„é‡‘ä¸¦åˆ†ææ˜¯å¦æœ‰åˆ©ã€‚

ç¯„ä¾‹ï¼š
â€¢ å–®åˆ† 50000 12/13.5 1140214 1140216 11406
â€¢ å¸³åˆ† 50000 12/13.5 11401 11406

ğŸ“Œ å¤šç­†è©¦ç®—åŠŸèƒ½ï¼ˆå«è©³ç´°æ˜ç´°ï¼‰
å¯ä¸€æ¬¡è©¦ç®—å¤šç­†ä¸åŒçš„åˆ†æœŸæ–¹æ¡ˆï¼Œä¸¦é¡¯ç¤ºæ¯ç­†çš„è©³ç´°é‚„æ¬¾è¨ˆç•«ã€‚

ç¯„ä¾‹ï¼š
å¤šç­†è©¦ç®— 1 å–®åˆ† 50000 12/13.5 1140102 1140116 2 å¸³åˆ† 50000 24/13.5 11310

ğŸ“Œ å¤šç­†æ¸…å„ŸåŠŸèƒ½
å¯ä¸€æ¬¡è©¦ç®—å¤šç­†åˆ†æœŸçš„æå‰æ¸…å„Ÿã€‚

ç¯„ä¾‹ï¼š
11406å¤šç­†æ¸…å„Ÿ 1 å¸³åˆ† 50000 12/13.5 11401 2 å–®åˆ† 25000 24/13.5 1140204 1140216

ğŸ“Œ å¤šæœŸæ¯”è¼ƒï¼ˆæ–°æ ¼å¼ï¼‰
å¿«é€Ÿæ¯”è¼ƒä¸åŒæœŸæ•¸çš„ç¸½æˆæœ¬ã€‚

ç¯„ä¾‹ï¼š
å¤šæœŸè©¦ç®— å¸³åˆ† 50000 12/13.5 11403

ğŸ’¡ å°æŠ€å·§ï¼š
â€¢ åˆ©ç‡å¾Œçš„%ç¬¦è™Ÿå¯åŠ å¯ä¸åŠ 
â€¢ ç³»çµ±æœƒè‡ªå‹•å„²å­˜æ¢ä»¶
â€¢ æ”¯æ´æ‰€æœ‰åˆ†æœŸé¡å‹
â€¢ å¤šç­†æ¸…å„Ÿæ”¯æ´å¤šç¨®è¼¸å…¥æ ¼å¼`;
            
            addMessage(guide, false, 1);
        }
        
        // é¡¯ç¤ºçŸ¥è­˜åº«
        function displayKnowledge() {
            const filter = document.getElementById('categoryFilter').value;
            const display = document.getElementById('knowledgeDisplay');
            
            let patterns = [...chatbot.knowledge.patterns];
            
            if (filter) {
                patterns = patterns.filter(p => p.dataType === filter);
            }
            
            patterns.sort((a, b) => b.usage - a.usage);
            
            const displayPatterns = patterns.slice(0, 50);
            
            display.innerHTML = displayPatterns.map(p => `
                <div style="background: #f7fafc; padding: 12px; margin-bottom: 10px; border-radius: 8px; font-size: 0.875rem; border-left: 3px solid #667eea;">
                    <strong>é¡å‹ï¼š</strong>${p.dataType || 'ä¸€èˆ¬'}<br>
                    <strong>æ¨¡å¼ï¼š</strong>${p.pattern.slice(0, 3).join(', ')}${p.pattern.length > 3 ? '...' : ''}<br>
                    <strong>ä½¿ç”¨æ¬¡æ•¸ï¼š</strong>${p.usage}<br>
                    <strong>ä¿¡å¿ƒåº¦ï¼š</strong>${Math.round(p.confidence * 100)}%
                </div>
            `).join('');
            
            if (displayPatterns.length === 0) {
                display.innerHTML = '<div style="text-align: center; color: #718096; padding: 20px;">å°šç„¡è³‡æ–™</div>';
            }
        }
        
        // è™•ç† Enter éµ
        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }
        
        // é‡ç½®å­¸ç¿’
        function resetLearning() {
            if (confirm('âš ï¸ ç¢ºå®šè¦é‡ç½®æ‰€æœ‰å­¸ç¿’è³‡æ–™å—ï¼Ÿé€™å€‹å‹•ä½œç„¡æ³•å¾©åŸï¼')) {
                if (confirm('âš ï¸ å†æ¬¡ç¢ºèªï¼šçœŸçš„è¦åˆªé™¤æ‰€æœ‰è³‡æ–™å—ï¼Ÿ')) {
                    localStorage.removeItem('enhanced_chatbot_knowledge');
                    localStorage.removeItem('enhanced_chatbot_stats');
                    localStorage.removeItem('lastCalculation');
                    location.reload();
                }
            }
        }
        
        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            chatbot.updateUI();
            
            // é¡¯ç¤ºç¯„ä¾‹æç¤º
            setTimeout(() => {
                const examples = [
                    "å¸³åˆ† 50000 12/13.5 11401",
                    "å–®åˆ† 30000 6/12 1140515 1140620 11406",
                    "å¤šç­†è©¦ç®— 1 å–®åˆ† 50000 12/13.5 1140102 1140116 2 å¸³åˆ† 50000 24/13.5 11310",
                    "11406å¤šç­†æ¸…å„Ÿ 1 å¸³åˆ† 50000 12/13.5 11401 2 å–®åˆ† 25000 24/13.5 1140204 1140216"
                ];
                
                const randomExample = examples[Math.floor(Math.random() * examples.length)];
                
                const message = `ğŸ’¡ æç¤ºï¼šè©¦è©¦çœ‹å®Œæ•´çš„åˆ†æœŸè©¦ç®—åŠŸèƒ½ï¼

ç¯„ä¾‹æŒ‡ä»¤ï¼š${randomExample}

æ–°åŠŸèƒ½ï¼š
â€¢ å¤šç­†åˆ†æœŸè©¦ç®—ï¼ˆå«è©³ç´°æ˜ç´°ï¼‰
â€¢ å¤šç­†æ¸…å„Ÿè©¦ç®—ï¼ˆå·²ä¿®æ­£è­˜åˆ¥å•é¡Œï¼‰
â€¢ æå‰æ¸…å„Ÿè©¦ç®—ï¼ˆå«é•ç´„é‡‘åˆ†æï¼‰
â€¢ æ™ºæ…§æœŸæ•¸èª¿æ•´

è¼¸å…¥ã€Œèªªæ˜ã€æŸ¥çœ‹å®Œæ•´ä½¿ç”¨æ–¹æ³•ã€‚`;
                
                addMessage(message, false, 1);
            }, 2000);
        });
    </script>
</body>
</html>         
          